<!DOCTYPE HTML>
<html>
<head>
    <title>Reviewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="Gato Responsive web template, Bootstrap Web Templates, Flat Web Templates, Andriod Compatible web template,
Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyErricsson, Motorola web design" />
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <link href="css/bootstrap.css" rel='stylesheet' type='text/css' />
    <!-- Custom Theme files -->
    <link href="css/style.css" rel='stylesheet' type='text/css' />
    <link href="css/myCss.css" rel='stylesheet' type='text/css' />
    <script src="js/jquery-2.2.3.min.js"> </script>
    <script src="js/bootstrap.min.js"> </script>
</head>
<body>
<!--start-home-->
<div id="home" class="header">
    <div class="header-bottom">
        <div class="container">
            <div class="logo">
                <a href=""><h1>Paper<span>_System</span></h1></a>
            </div>
            <span class="menu"></span>
            <div class="top-menu">
                <ul>
                    <nav>
                        <li><a href="viewPaper.html">查阅论文</a></li>
                        <li><a href="reviewer.html">审稿</a></li>
                        <li><a onclick="logOut();">退出</a></li>
                    </nav>
                </ul>
            </div>

            <!-- script for menu -->
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="banner two">
        <div class="container">
            <div class="pag-nav">
                <ul class="p-list">
                    <li><a href="#" onclick="unReviewPage()">待审阅</a></li> &nbsp;&nbsp;/&nbsp;
                    <li><a href="#" onclick="reviewedPageNew()">已审阅（有更新）</a></li>/&nbsp;
                    <li><a href="#" onclick="reviewedPage()">已审阅</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!--error-->

<div class="contact" id="unReview">

</div>
<div class="contact" id="reviewedNew">

</div>
<div class="contact" id="reviewed">

</div>

<div class="contact">

</div>


<script type="text/javascript">
    $(document).ready(function(){
        unReviewPage();
    })

    function showPaperInfo(data, flag, tagID) {
        var content = '';

        var paperMsg = "作者: " + data.author + "  提交时间: " + data.submittime + "  关键词: ";

        $.ajax({
            url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Keywords/?Keywords.match.id="+data.id,
            type: "GET",
            async: false,
            success: function (keywordsdata) {
                var keywords = eval(keywordsdata);

                if (!jQuery.isEmptyObject(keywords)) {
                    for (var i = 0; i < keywords.Keywords.length; i++) {
                        paperMsg += keywords.Keywords[i].word;
                    }
                }
                content += '\
                        <div class="modal fade" id="Modal'+data.id+'" tabindex="-1" role="dialog"\
                             aria-labelledby="myModalLabel" aria-hidden="true">\
                            <div class="modal-dialog">\
                                <div class="modal-content">\
                                    <div class="modal-header">\
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>\
                                        <h4 class="modal-title" id="myModalLabel">请选择评审意见</h4>\
                                    </div>\
                                    <div class="modal-body">\
                                        <table align="center">\
                                            <tr>\
                                                <td><label for="name">审稿意见</label></td>\
                                                <td><select id="advice'+data.id+'" class="form-control"> \
                                                    <option value="Strong Accept">Strong Accept</option>\
                                                    <option value="Accept">Accept</option>\
                                                    <option value="Weak Accept">Weak Accept</option>\
                                                    <option value="Borderline Paper">Borderline Paper</option>\
                                                    <option value="Weak Reject">Weak Reject</option>\
                                                    <option value="Reject">Reject</option>\
                                                    <option value="Strong Reject">Strong Reject</option>\
                                                </select></td>\
                                            </tr>\
                                            <tr>\
                                                <td><label for="name">信任度</label></td>\
                                                <td><select id="confidence'+data.id+'" class="form-control"> \
                                                    <option value="Expert">Expert</option>\
                                                    <option value="High">High</option>\
                                                    <option value="Medium">Medium</option>\
                                                    <option value="Low">Low</option>\
                                                    <option value="Null">Null</option>\
                                                </select></td>\
                                            </tr>\
                                        </table>\
                                    </div>\
                                    <div class="modal-footer">\
                                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>\
                                        <button type="button" class="btn btn-primary" onclick="addAdvice('+data.id+')">提交</button>\
                                    </div>\
                                </div><!-- /.modal-content -->\
                            </div><!-- /.modal-dialog -->\
                        </div><!-- /.modal -->';

                if (flag % 2 == 0) {
                    content += '<div class="container" style="background: #d9d9d9;">\
                                    <div class="mytext">\
                                        <textarea class="myTitleText myTitleTextAdd myTextArea" style="background: #d9d9d9;" \
                                            onclick="ShowPaperClick(' + data.id + ')">' + data.title + '</textarea> \
                                        <h1 class="myMsgText">'+paperMsg+'</h1>\
                                    </div>';
                }
                else {
                    content += '<div class="container" style="background: #f0f0f0;">\
                                    <div class="mytext">\
                                        <textarea class="myTitleText myTitleTextAdd myTextArea" style="background: #f0f0f0;" \
                                            onclick="ShowPaperClick(' + data.id + ')">' + data.title + '</textarea> \
                                        <h1 class="myMsgText">'+paperMsg+'</h1>\
                                    </div>';
                }
                content += '<div>\
                        <input type="button" class="mybutton" value="添加意见" onclick="addAdviceClick(' + data.id + ')">\
                        <input type="button" class="mybutton" value="查看意见" onclick="checkAdviceClick(' + data.id + ')">\
                    </div>\
                </div>';

                $(tagID).append(content);
                $(tagID).show('slow');
            }
        });
    }
</script>

<script type="text/javascript">
    function unReviewPage() {
        $("#reviewedNew").hide('slow');
        $("#reviewed").hide('slow');

        var username = localStorage.getItem("name");
        var role = localStorage.getItem("role");

        var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/User/";
        myurl = myurl + "?User.name="+username;

        var content = '<div class="container">\
                            <div class="contact-main">\
                                <h1 class="myheadText" style="font-size:30px">论文名</h1>\
                                <h1 class="myheadLabel">添加意见</h1>\
                                <h1 class="myheadLabel">查看意见</h1>\
                            </div>\
                        </div>';
        $("#unReview").html(content);
        $("#unReview").show('slow');

        $.ajax({
            url: myurl,
            type: "GET",
            success: function (data) {
                var obj = eval(data);
                var papers = obj.User[0].check;

                var color = 0;
                for (var i = 0; i < papers.length; i++) {
                    if (papers[i].status != "FirstTrial") {
                        continue;
                    }
                    myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/?Comment.reviewer="+username;
                    myurl = myurl + "&Comment.commentwhat.id="+papers[i].id;
                    $.ajax({
                        url: myurl,
                        async:false,
                        type: "GET",
                        success: function (data2) {
                            var obj2 = eval(data2);
                            if (jQuery.isEmptyObject(obj2)) {
                                showPaperInfo(papers[i], color,"#unReview");
                                color++;
                            }
                        }
                    });
                }
            }
        });
    }

    function reviewedPageNew(){
        $("#unReview").hide('slow');
        $("#reviewed").hide('slow');

        var username = localStorage.getItem("name");
        var role = localStorage.getItem("role");

        var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/User/";
        myurl = myurl + "?User.name="+username;

        var content = '<div class="container">\
                            <div class="contact-main">\
                                <h1 class="myheadText" style="font-size:30px">论文名</h1>\
                                <h1 class="myheadLabel">添加意见</h1>\
                                <h1 class="myheadLabel">查看意见</h1>\
                            </div>\
                        </div>';
        $("#reviewedNew").html(content);
        $("#reviewedNew").show('slow')

        $.ajax({
            url: myurl,
            type: "GET",
            success: function (data) {
                var obj = eval(data);
                var papers = obj.User[0].check;
                var color = 0;
                for (var i = 0; i < papers.length; i++) {
                    myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/?Comment.reviewer="+username;
                    myurl = myurl + "&Comment.commentwhat.id="+papers[i].id;
                    $.ajax({
                        url: myurl,
                        type: "GET",
                        async:false,
                        success: function (data2) {
                            var obj2 = eval(data2);
                            if (!jQuery.isEmptyObject(obj2)) {
                                var commentTime = obj2.Comment[0].edittime;
                                var cTimes = commentTime.split("-");

                                var paperTime = papers[i].edittime;
                                var pTimes = paperTime.split("-");
                                var f = 1;
                                for (var j = 0; j < 3; j++) {
                                    if (cTimes[j]+pTimes[j] < pTimes[j]+cTimes[j]) {
                                        f = -1;
                                        break;
                                    }
                                    else if (cTimes[j]+pTimes[j] > pTimes[j]+cTimes[j]){
                                        f = 1;
                                        breakl
                                    }
                                }

                                if (f == -1) {
                                    showPaperInfo(papers[i], color, "#reviewedNew");
                                    color++;
                                }
                            }
                        }
                    });

                }
            }
        });
    }

    function reviewedPage() {
        $("#unReview").hide('slow');
        $("#reviewedNew").hide('slow');

        var username = localStorage.getItem("name");
        var role = localStorage.getItem("role");

        var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/User/";
        myurl = myurl + "?User.name="+username;

        var content = '<div class="container">\
                            <div class="contact-main">\
                                <h1 class="myheadText" style="font-size:30px">论文名</h1>\
                                <h1 class="myheadLabel">添加意见</h1>\
                                <h1 class="myheadLabel">查看意见</h1>\
                            </div>\
                        </div>';
        $("#reviewed").html(content);
        $("#reviewed").show('slow');

        $.ajax({
            url: myurl,
            type: "GET",
            success: function (data) {
                var obj = eval(data);
                var papers = obj.User[0].check;
                var color = 0;
                for (var i = 0; i < papers.length; i++) {
                    myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/?Comment.reviewer="+username;
                    myurl = myurl + "&Comment.commentwhat.id="+papers[i].id;
                    $.ajax({
                        url: myurl,
                        type: "GET",
                        async:false,
                        success: function (data2) {
                            var obj2 = eval(data2);
                            if (!jQuery.isEmptyObject(obj2)) {
                                var commentTime = obj2.Comment[0].edittime;
                                var cTimes = commentTime.split("-");

                                var paperTime = papers[i].edittime;
                                var pTimes = paperTime.split("-");

                                var f = 1;
                                for (var j = 0; j < 3; j++) {
                                    if (cTimes[j]+pTimes[j] < pTimes[j]+cTimes[j]) {
                                        f = -1;
                                        break;
                                    }
                                    else if (cTimes[j]+pTimes[j] > pTimes[j]+cTimes[j]){
                                        f = 1;
                                        break;
                                    }
                                }

                                if (f == 1) {
                                    showPaperInfo(papers[i], color, "#reviewed");
                                    color++;
                                }
                            }
                        }
                    });

                }
            }
        });
    }
</script>

<script tpye="text/javascript">
    function checkAdviceClick(data) {
        var paperID = data;
        var url = "viewAdvice.html?pid="+paperID;
        window.open(url,"","top=150,left=300,width=600,height=400");
    }

    function addAdviceClick(paperID) {
        $("#Modal"+paperID).modal();
    }

    function addAdvice(paperID) {
        var advice = $("#advice"+paperID).val();
        var confidence = $("#confidence"+paperID).val();
        var username = localStorage.getItem("name");

        myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/?Comment.reviewer="+username;
        myurl = myurl + "&Comment.commentwhat.id="+paperID;
        $.ajax({
            url: myurl,
            async:false,
            type: "GET",
            success: function (data2) {
                var obj2 = eval(data2);
                if (!jQuery.isEmptyObject(cData)) {
                    var oldcomment = eval(cData);
                    oldcomment.commentwhat = {"id":paperID, "type":"Paper"};
                    var uid = oldcomment.whocomment.id;
                    oldcomment.whocomment = {"id": uid, "type":"User"};
                    oldcomment.advice = advice;
                    oldcomment.confidence = confidence;
                    var nowDate = new Date();
                    oldcomment.edittime = nowDate.getFullYear() + "-" + nowDate.getMonth() + "-" + nowDate.getDate();

                    $.ajax({
                        url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Paper/"+paperID,
                        contentType: "application/json",
                        type: "PUT",
                        data: JSON.stringify(oldcomment),
                        success: function (commentD) {

                        }
                    });
                    return;
                }
                else {
                    var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/User/?User.name="+username;
                    var userid;
                    var nowDate = new Date();
                    var edittime = nowDate.getFullYear() + "-" + nowDate.getMonth() + "-" + nowDate.getDate();
                    $.ajax({
                        url: myurl,
                        type: "GET",
                        success: function (data) {
                            var obj = eval(data);
                            userid = obj.User[0].id;

                            var comment = {
                                "reviewer":username,
                                "advice":advice,
                                "confidence":confidence,
                                "edittime":edittime,
                                "commentwhat":{"id":paperID, "type":"Paper"},
                                "whocomment":{"id":userid, "type":"User"}
                            }

                            $.ajax({
                                url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/",
                                contentType: "application/json",
                                type: "POST",
                                data: JSON.stringify(comment),
                                success: function (data) {
                                    var obj = eval(data);

                                    // 评论数量达到3个时送至终审
                                    $.ajax({
                                        url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/?Comment.commentwhat.id="+paperID,
                                        type: "GET",
                                        success: function (commentsData) {
                                            var comments = eval(commentsData);
                                            if (comments.Comment.length >= 3) {
                                                $.ajax({
                                                    url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Paper/?Paper.id=" + paperID,
                                                    type: "GET",
                                                    success: function (oldpaperdata) {
                                                        var oldPaper = eval(oldpaperdata).Paper[0];
                                                        oldPaper.status = "FinalJudgement";
                                                        $.ajax({
                                                            url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Paper/"+paperID,
                                                            contentType: "application/json",
                                                            type: "PUT",
                                                            data: JSON.stringify(oldPaper),
                                                            success: function (newpaper) {

                                                            }
                                                        });
                                                    }
                                                });
                                            }
                                        }
                                    });
                                }
                            });



                        }
                    });
                }
            }
        });


        $("#Modal"+paperID).modal("hide");
    }

</script>
</body>
</html>