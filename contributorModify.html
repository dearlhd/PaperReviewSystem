<!DOCTYPE HTML>
<html>
<head>
<title>contributorModify</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
<link href="css/bootstrap.css" rel='stylesheet' type='text/css' />
<!-- Custom Theme files -->
<link href="css/style.css" rel='stylesheet' type='text/css' />	
<link href="css/myCss.css" rel='stylesheet' type='text/css' />
<script src="js/jquery-2.2.3.min.js"> </script>
<script src="js/bootstrap.min.js"> </script>

</head>
<body>
	<!--start-home-->
	<div id="home" class="header">
		<div class="header-bottom">
			<div class="container">
				<div class="logo">
					<a href="index.html"><h1>Paper<span>_System</span></h1></a>
				</div>
				<span class="menu"></span>
				<div class="top-menu">
					<ul>
					<nav>
            <li><a onclick="QueryClick();">Query</a></li> 
						<li><a onclick="DissertClick();">Dissert</a></li> 
						<li><a onclick="MyPaperClick();">MyPaper</a></li>
						<li><a onclick="MyLogOutClick();">LogOut</a></li>	
					</nav>
					</ul>
				</div>
				
			<!-- script for menu -->
				<div class="clearfix"></div>
			</div>
		</div>

	<div class="banner two">
		<div class="container">	
		  <div class="pag-nav">
				<ul class="p-list">
					<li><a href="index.html"></a></li>
				</ul>
			</div>

		</div>   
	</div>
	</div>

<div class="contact" id="my_contact">
</div>

<div class="contact">
</div>

</body>
</html>


<script>
    var my_obj;
    var paperId;
    var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/";

    function SubmitPaperClick(){
      //alert($("#paper").html());
      var title = $("#title").val();
      var unit = $("#unit").val();
      var address = $("#address").val();
      var summary = $("#summary").val();
      var content = $("#content");
      var keywords = $("#keywords").val();
      var submittime = my_obj.Paper[0].submittime;
      var myDate = new Date();
      var edittime = myDate.getFullYear() + "-" + myDate.getMonth() + "-" + myDate.getDate();
      paperId = my_obj.Paper[0].id;

      var status = "Delivered";//////////////////////////////////////////////////////////////////////////////////update
      if ((title != null) && (unit != null) && (address != null) && (summary != null) && (keywords != null) && (content != null))//not null
      {
        $.ajax({
          url: myurl + "Keywords/?Keywords.match.id=" + paperId,
          type : "GET",
          async : false,
          success : function(msg){
          var obj = eval(msg);    
            if (jQuery.isEmptyObject(obj)){
              return false;
            }
           // console.log("IN 1");
            for (var i = 0; i < obj.Keywords.length; ++i){
              console.log(obj.Keywords[i].id);
              $.ajax({
                url : myurl + "Keywords/" + obj.Keywords[i].id,
                async : false,
                type : "DELETE",
                success : function(){
                  //console.log("In 2");
                }
              });
            }
         }
        });

        var paperInfo={
            ////////////////////////
          "title" : title,
          "author" : my_obj.Paper[0].author,
          "unit" : unit,
          "address" : address,
          "summary" : summary,
          "submittime" : submittime,
          "edittime" : edittime,
          "status" :　status
        };
        //alert(username);
        //alert(submittime);
        $.ajax({
          url: myurl + "Paper/" + paperId,
          contentType: "application/json",
          type: "PUT",
          async : false,
          data: JSON.stringify(paperInfo),
          success: function(msg){
              var obj = eval(msg);
              var paperId = obj.id;
            //alert(paperId);
           // console.log("In put paper");

              var files = $(":file")[0].files;
            //alert(files);
              var formData = new FormData();
              formData.append("file", files[0]);
              $.ajax({
                  url: myurl + "Paper/" + paperId,
                  type: "POST",
                  data: formData,
                  async : false,
                  contentType: false,
                  processData: false,
                  success: function(data){
                      //console.log(data);
                     // alert("add file");
                  } 
              });
              //do keywords

              var keylist = keywords.split(";");
              //alert(keylist.length);
              
              for (var i = 0; i < keylist.length; ++i){
                var keywordsInfo={
                  "word" : keylist[i],
                  "match" : {"id" : paperId, "type" : "Paper"}
                };
                console.log(keywordsInfo.word);
                $.ajax({
                  url: myurl + "Keywords/",
                  contentType: "application/json",
                  async : false,
                  type: "POST",
                  data: JSON.stringify(keywordsInfo),
                  success: function(msg){
                    //alert("add keywords" + keylist[i]);
                    //console.log("In Keywords" + keywordsInfo.word);
                  }
                });
              
              }
          }
        });
      }
      else 
      {
        sweetAlert("以上几项不能为空!");
        return false;
      }

      window.location.href = "contributor.html";
      
      /*if (sweetAlert("论文修改成功！") < 2)
      {
        window.location.href = "contributor.html";
      }*/
    }

    function ModifyClick(){

      /*$("#my_contact").html("<h1 class='myheadText'>Plllaper</h1><h1 class='myheadLabel'>Modllllify</h1><h1 class='myheadLabel'>Advillce</h1><h1 class='myheadLabel'>Status</h1>");
      alert($("#my_contact").html());*/
      var keywords = "";
      $("#my_contact").hide();
      $.ajax({
        url : myurl + "Paper/?Paper.id=" + paperId,
        type : "GET",
        success : function(msg){
          my_obj = eval(msg);
          if (jQuery.isEmptyObject(my_obj)){
            return false;
          }

         // console.log("In there");
        //  console.log(my_obj.Paper[0].title);

          $.ajax({
            url: myurl + "Keywords/?Keywords.match.id=" + my_obj.Paper[0].id,
            type : "GET",
            success : function(_msg){
              var _obj = eval(_msg);    
              if (jQuery.isEmptyObject(_obj)){
                return false;
              }
              for (var i = 0; i < _obj.Keywords.length; ++i)
                if (i < (_obj.Keywords.length - 1))
                  keywords += (_obj.Keywords[i].word + ";");
                else keywords += _obj.Keywords[i].word;
                //optimize

              $("#my_contact").html("" +
                "<div class='container' id='paper'>" + 
                  "<input class='myinput' id='title' placeholder='标题' value='" + my_obj.Paper[0].title + "'>" + 
                  "<input class='myinput' id='unit' placeholder='作者单位' value='" + my_obj.Paper[0].unit + "'>" + 
                  "<input class='myinput' id='address' placeholder='通讯地址' value='" + my_obj.Paper[0].address + "'>" + 
                  "<input class='myinput' id='keywords' placeholder='关键词(用分号隔开)' value='" + keywords + "'>" +
                  "<textarea class='myinput' style='height:300px;' id='summary' placeholder='摘要'>" + my_obj.Paper[0].summary + "</textarea>" +  
                  "<input type='file' class='myinput' style='width:40%' name='file' id='content' placeholder='上传正文pdf'>" + 
                  "<input type='button' class='mybutton' style='float:none;'' value='提交'' onclick='SubmitPaperClick();''>" +
                "</div>"
              );
            }
          });
          $("#my_contact").show("slow");
        }

      });

    }

    function MyPaperClick(){
      window.location.href = "contributor.html";
    }

    function MyLogOutClick(){
      window.location.href = "login.html";
    }

    function QueryClick(){
      window.open("queryPaper.html", "", "");
    }

    function GetRequest() {
      var url = location.search; //获取url中"?"符后的字串
      var theRequest = new Object();
      if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
          theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
        }
      }
      return theRequest;
    }

    $(document).ready(function(){
      var Request = new Object();
      Request = GetRequest();
      paperId = Request['pid'];
      ModifyClick();
    });

</script>