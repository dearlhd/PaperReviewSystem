<!DOCTYPE HTML>
<html>
<head>
    <title>Final Judgement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="Gato Responsive web template, Bootstrap Web Templates, Flat Web Templates, Andriod Compatible web template,
Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyErricsson, Motorola web design" />
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <link href="css/bootstrap.css" rel='stylesheet' type='text/css' />
    <!-- Custom Theme files -->
    <link href="css/style.css" rel='stylesheet' type='text/css' />
    <link href="css/myCss.css" rel='stylesheet' type='text/css' />
    <script src="js/jquery-2.2.3.min.js"> </script>
    <script src="js/bootstrap.min.js"> </script>
</head>
<body>
<!--start-home-->
<div id="home" class="header">
    <div class="header-bottom">
        <div class="container">
            <div class="logo">
                <a href=""><h1>Paper<span>_System</span></h1></a>
            </div>
            <span class="menu"></span>
            <div class="top-menu">
                <ul>
                    <nav>
                        <li><a href="viewPaper.html">查阅论文</a></li>
                        <li><a href="chairman.html">分配任务</a></li>
                        <li><a href="finalJudgement.html">终审</a></li>
                        <li><a href="privilegeManagement.html">权限管理</a></li>
                        <li><a href="login.html">退出</a></li>
                    </nav>
                </ul>
            </div>

            <!-- script for menu -->
            <div class="clearfix"></div>
        </div>
    </div>

    <div class="banner two">
        <div class="container">
            <div class="pag-nav">
                <ul class="p-list">

                </ul>
            </div>
        </div>
    </div>
</div>
<!--error-->

<div class="contact" id="finalJudgement">

</div>
<div class="contact" id="modalpos">
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                </div>
                <div class="modal-body">
                    <table align="center">
                        <tr><h2 id="modalTip">是否通过审批？</h2></tr>
                        <br>
                        <tr id = "modalContent" >

                        </tr>

                        <tr id="FinalJudgeBtn">

                        </tr>
                    </table>
                </div>
                <div class="modal-footer" id="modal-footer">

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->';
</div>

<script type="text/javascript">
    $(document).ready(function(){
        finalJudgementPage();
    })


    function sortPaperByCredit(papers) {
        for (var i = 0; i < papers.length; i++) {
            for (var j = i+1; j < papers.length; j++) {
                if (papers[i].credit < papers[j].credit) {
                    var tmp = new Object();
                    tmp = papers[i];
                    papers[i] = papers[j];
                    papers[j] = tmp;
                }
            }
        }
        return papers;
    }

    function showPaperInfo(data, flag, tagID) {
        console.log("credit: "+data.credit);
        var content = '';
        var paperMsg = "作者: " + data.author + "  提交时间: " + data.submittime + "  关键词: ";

        $.ajax({
            url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Keywords/?Keywords.match.id="+data.id,
            type: "GET",
            async: false,
            success: function (keywordsdata) {
                var keywords = eval(keywordsdata);

                if (!jQuery.isEmptyObject(keywords)) {
                    for (var i = 0; i < keywords.Keywords.length; i++) {
                        paperMsg += keywords.Keywords[i].word;
                    }
                }

                if (flag % 2 == 0) {
                    content += '<div class="container" style="background: #d9d9d9;">\
                                    <div class="mytext">\
                                        <textarea class="myTitleText myTitleTextAdd myTextArea" style="background: #d9d9d9;" \
                                            onclick="ShowPaperClick(' + data.id + ')">' + data.title + '</textarea> \
                                        <h1 class="myMsgText">'+paperMsg+'</h1>\
                                    </div>';
                }
                else {
                    content += '<div class="container" style="background: #f0f0f0;">\
                                    <div class="mytext">\
                                        <textarea class="myTitleText myTitleTextAdd myTextArea" style="background: #f0f0f0;" \
                                            onclick="ShowPaperClick(' + data.id + ')">' + data.title + '</textarea> \
                                        <h1 class="myMsgText">'+paperMsg+'</h1>\
                                    </div>';
                }
                content += '<div>\
                        <input type="button" class="mybutton" value="审批" onclick="judgeClick(' + data.id + ')">\
                        <input type="button" class="mybutton" value="查看意见" onclick="checkAdviceClick(' + data.id + ')">\
                    </div>\
                </div>';

                $(tagID).append(content);
                $(tagID).show('slow');
            }
        });
    }
</script>

<script type="text/javascript">
    function finalJudgementPage() {
        var username = localStorage.getItem("name");
        var role = localStorage.getItem("role");

        var content = '<div class="container">\
                            <div class="contact-main">\
                                <h1 class="myheadText" style="font-size:30px">论文名</h1>\
                                <h1 class="myheadLabel">审批</h1>\
                                <h1 class="myheadLabel">查看意见</h1>\
                            </div>\
                        </div>';
        $("#finalJudgement").html(content);
        $("#finalJudgement").show('slow');

        var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Paper/?Paper.status=FinalJudgement";

        $.ajax({
            url: myurl,
            type: "GET",
            success: function (data) {
                var obj = eval(data);
                var papers = obj.Paper;

                if (jQuery.isEmptyObject(papers)) {
                    return false;
                }

                console.log(papers);
                var color = 0;
                for (var i = 0; i < papers.length; i++) {
                    $.ajax({
                        async:false,
                        url:"http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Comment/?Comment.commentwhat.id="+papers[i].id,
                        type:"GET",
                        success:function (commentsData) {
                            var credit = 0;
                            var comments = eval(commentsData).Comment;
                            for (var j = 0; j < comments.length; j++) {
                                if (comments[i].advice == "Strong Accept") credit += 6;
                                else if (comments[i].advice == "Accept") credit += 5;
                                else if (comments[i].advice == "Weak Accept") credit += 4;
                                else if (comments[i].advice == "Borderline Paper") credit += 3;
                                else if (comments[i].advice == "Weak Reject") credit += 2;
                                else if (comments[i].advice == "Reject") credit += 1;
                                else if (comments[i].advice == "Strong Reject") credit += 0;

                                if (comments[i].confidence == "Expert") credit += 4;
                                else if (comments[i].confidence == "High") credit += 3;
                                else if (comments[i].confidence == "Medium") credit += 2;
                                else if (comments[i].confidence == "Low") credit += 1;
                                else if (comments[i].confidence == "Null") credit += 0;
                            }
                            papers[i].credit = credit;
                        }
                    });
                }

                papers = sortPaperByCredit(papers);
                console.log(papers);
                for (var i = 0; i < papers.length; i++) {
                    showPaperInfo(papers[i], color, "#finalJudgement");
                    color++;
                }
            }
        });
    }
</script>

<script tpye="text/javascript">
    function checkAdviceClick(data) {
        var paperID = data;
        console.log(paperID);
        var url = "viewAdvice.html?pid="+paperID;
        window.open(url,"","top=150,left=300,width=600,height=400");
    }

    function judgeClick(paperID) {
        var content = '<button type="button" class="btn btn-success btn-lg" onclick="finalJudge('+paperID+',1)">通过</button>\
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
                        <button type="button" class="btn btn-danger btn-lg" onclick="finalJudge('+paperID+',0)">拒绝</button>';
        $("#FinalJudgeBtn").html(content);
        $("#myModal").modal();


    }

    function finalJudge(paperID,tag) {
        console.log("final");
        console.log(tag);
        var myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Paper/?Paper.id="+paperID;
        $.ajax({
            url: myurl,
            type: "GET",
            success: function (oldpaperdata) {
                var oldPaper = eval(oldpaperdata).Paper[0];
                if (tag == 1) {
                    oldPaper.status = "Passed";
                }
                else {
                    oldPaper.status = "Failed";
                }
                console.log(oldPaper);
                $.ajax({
                    url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Paper/"+paperID,
                    contentType: "application/json",
                    type: "PUT",
                    data: JSON.stringify(oldPaper),
                    success: function (newpaper) {
                        archivePaper(oldPaper.id);
                        var tagContent = '<input type="text" class="form-control" id="tags" placeholder="请输入标签，以；隔开">';
                        var footer = '<button type="button" class="btn btn-default" data-dismiss="modal">close</button>\
                                      <button type="button" class="btn btn-primary" onclick="addTags('+oldPaper.id+')">submit</button>';

                        $("#modalTip").html("请添加标签！");
                        $("#FinalJudgeBtn").html("");
                        $("#modalContent").html(tagContent);
                        $("#modal-footer").html(footer);
                    }
                });
            }
        });

    }

    function archivePaper(obj) {
        var rdfXML = "";
        myurl = "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/";
        $.ajax({
            url : myurl + "Paper/?Paper.id=" + obj,
            async : false,
            type : "GET",
            success : function(msg){
                my_obj = eval(msg);
                if (jQuery.isEmptyObject(my_obj)){
                    return false;
                }
             $.ajax({
             url: myurl + "Keywords/?Keywords.match.id=" + my_obj.Paper[0].id,
             async : false,
             type : "GET",
             success : function(_msg){
             var _obj = eval(_msg);
             if (jQuery.isEmptyObject(_obj)){
             return false;
             }
             var keywords_array = new Array();
             var kw_len = _obj.Keywords.length;
             for (var i = 0; i < kw_len; ++i){
             keywords_array[i] = _obj.Keywords[i].word;
             }
             var tags_array = new Array();
             var tg_len = 0;

             $.ajax({
             url : myurl + "Tags/?Tags.tagtopaper.id=" + my_obj.Paper[0].id,
             type : "GET",
             async : false,
             success : function(tg_msg){
             var tg_obj = eval(tg_msg);
             if (!jQuery.isEmptyObject(tg_obj)){
             tg_len = tg_obj.Tags.length;
             for (var i = 0; i < tg_len; ++i){
             tags_array[i] = tg_obj.Tags[i].word;
             }
             }
             }
             });

             rdfXML = "" +
             "<?xml version='1.0'?>" +
             "<rdf:RDF" +
             "xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'" +
             "xmlns:cd='" + myurl + "Paper/" + "'" +
             "xmlns:kw='" + myurl + "Keywords/" + "'" +
             "xmlns:tg='" + myurl + "Tags/" + "'" +
             "xmlns:cont='http://202.120.40.73:28080/file/Ubfca480238c858/PaperRev/Paper/'>";

             rdfXML += "" +
             "<rdf:Description rdf:about='" + myurl + "Paper/" + my_obj.Paper[0].id + "'>" +
             "<cd:type>paper</cd:type>" +
             "<cd:id>" + my_obj.Paper[0].id + "</cd:id>" +
             "<cd:title>" + my_obj.Paper[0].title + "</cd:title>" +
             "<cd:author>" + my_obj.Paper[0].author + "</cd:author>" +
             "<cd:unit>" + my_obj.Paper[0].unit + "</cd:unit>" +
             "<cd:address>" + my_obj.Paper[0].address + "</cd:address>" +
             "<cd:summary>" + my_obj.Paper[0].summary + "</cd:summary>" +
             "<cd:submittime>" + my_obj.Paper[0].submittime + "</cd:submittime>" +
             "<cd:status>" + my_obj.Paper[0].status + "</cd:status>" +
             "<cd:edittime>" + my_obj.Paper[0].edittime + "</cd:edittime>";

             rdfXML += "<kw:word>" +
             "<rdf:Bag>";
             for (var i = 0; i < kw_len; ++i){
             rdfXML +=   "<rdf:li>" + keywords_array[i] + "</rdf:li>";
             }
             rdfXML +=   "</rdf:Bag>" +
             "</kw:word>";

             rdfXML += "<tg:word>" +
             "<rdf:Bag>";
             for (var i = 0; i < tg_len; ++i){
             rdfXML +=   "<rdf:li>" + tags_array[i] + "</rdf:li>"
             }
             rdfXML +=   "</rdf:Bag>" +
             "</tg:word>";

             rdfXML += "<cont:content rdf:resource='http://202.120.40.73:28080/file/Ubfca480238c858/PaperRev/Paper/" + my_obj.Paper[0].id + "'/>";

             rdfXML += "</rdf:Description>";

             rdfXML += "</rdf:RDF>";
             //alert(rdfXML);
             }
             });
             //alert(rdfXML);

             var paperInfo = {
             "title" : my_obj.Paper[0].title,
             "author" : my_obj.Paper[0].author,
             "unit" : my_obj.Paper[0].unit,
             "address" : my_obj.Paper[0].address,
             "summary" : my_obj.Paper[0].summary,
             "content" : rdfXML,
             "submittime" : my_obj.Paper[0].submittime,
             "status" : my_obj.Paper[0].status,
             "edittime" : my_obj.Paper[0].edittime
             };

             $.ajax({
             url: "http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/" + "Paper/" + my_obj.Paper[0].id,
             contentType: "application/json",
             type: "PUT",
             async : false,
             data: JSON.stringify(paperInfo),
             success: function(msg){
             }
             });
             }
         });

    }

    function addTags (paperId) {
        var tags = $("#tags").val();
        tags = tags.split(';');
        console.log(tags);
        for (var i = 0; i < tags.length; i++) {
            var tagInfo = {
                "word":tags[i],
                "tagtopaper": {
                    "id":paperId,
                    "type":"Paper"
                }
            }
            $.ajax({
                async:false,
                url:"http://202.120.40.73:28080/Entity/Ubfca480238c858/PaperRev/Tags",
                type:"POST",
                contentType: "application/json",
                data: JSON.stringify(tagInfo),
                success:function (msg) {
                    console.log("tag added");
                }
            });
        }
        $("#myModal").modal("hide");
        finalJudgementPage();
    }
</script>
</body>
</html>